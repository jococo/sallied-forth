/*! salliedforth 2013-Dec-27 */
!function(a){"use strict";function b(a,b){var c;for(c in b)b.hasOwnProperty(c)&&(a.hasOwnProperty(c)||void 0!==a[c]||(a[c]=b[c]));return a}var c=function(a,b,c,d){var e=this;this.name=a,this.fn=function(){e.functions.forEach(function(a){a.call(c)})},this.errorFn=d||function(a){console.error("FORTH ERROR::CustomCommand: "+a)},this.prev=b,this.functions=[],this.add=function(a){"function"==typeof a?e.functions.push(a):e.functions.push(function(){c.pushToDataStack(function(a){return a}(a))})},this.executeAfterCreation=!1},d=function(a){var b=this;this._data=[],this.fn=function(){a.pushToDataStack(b._data)},this.add=function(a){b._data.push(a)},this.executeAfterCreation=!0},e=function(a){var b=this;this._data={},this.fn=function(){void 0===b.key?a.pushToDataStack(b._data):a.error("Unmatched key value pairs when defining Object. Key '"+b.key+"' does not have a value!")},this.key=void 0,this.add=function(a){void 0===b.key?b.key=a:(b._data[b.key]=a,b.key=void 0)},this.executeAfterCreation=!0},f=function(a){this.data=[],this.status=a,this.stackLength=0};f.prototype.push=function(a){this.data.push(a)},f.prototype.pop=function(){return this.data.pop()},a.Interpreter=function(a){var g=this;this.dataStack=[],this.returnStack=[],this.dictionary=void 0,this.dictionaryHead=void 0,this.valueStore=b(a||{},{"false":!1,"true":!0}),this.version={major:0,minor:0,build:1,revision:void 0},this.versionString=""+this.version.major+"."+this.version.minor+"."+this.version.build,this.version.revision&&(this.versionString=this.versionString+"."+this.version.revision),this.log=function(a){return g.logFn&&g.logFn(a),void 0},this.error=function(a){return g.errorFn&&g.errorFn(a),void 0},this.pushToDataStack=function(){var a=Array.prototype.slice.call(arguments);a.forEach(function(a){g.dataStack.push(a)})},this.popFromDataStack=function(){return g.dataStack.length<1&&g.error("StackUnderFlow!"),g.dataStack.pop()},this.addToDictionary=function(a,b,c){if(g.dictionaryHead){var d={name:a,fn:b,prev:g.dictionaryHead,immediate:!!c};g.dictionaryHead=d}else g.dictionary=g.dictionaryHead={name:a,fn:b,immediate:!!c}},this.setValue=function(a,b){this.valueStore[a]=b},this.getValue=function(a){return this.valueStore[a]},this.findDefn=function(a,b){return b===a.name?a:a.prev?g.findDefn(a.prev,b):void 0},this.findDefinition=function(a){if(g.dictionaryHead){var b=g.findDefn(g.dictionaryHead,a);return b}return void 0},this.executeFunctions=function(){var a=Array.prototype.slice.call(arguments);a.forEach(function(a){a.call(g)})},this.executeWords=function(){var a=Array.prototype.slice.call(arguments);try{var b=a.map(function(a){var b=g.findDefinition(a);if(b)return b.fn;throw"Function "+a+" not found!"});g.executeFunctions.apply(g,b)}catch(c){g.error(c)}},this.executeString=function(a){g.executeWords.apply(g,a.split(" "))},this.processCommands=function(){for(var a;a=g.commands.shift();)if(a){var b=parseFloat(a);if(isNaN(b))if(g.compilationMode){var c=g.findDefinition(a);c?c.immediate?c.fn():g.newCommand.add(c.fn):g.newCommand.add(a)}else g.executeWords(a);else g.compilationMode?g.newCommand.add(b):g.pushToDataStack(b)}},this.interpret=function(a){return g.response=new f("OK."),g.commands=a.split(" "),g.processCommands(),g.response.stackLength=g.dataStack.length,g.response},this.logFn=function(a){g.response.push(a)},this.setLogFunction=function(a){this.logFn=a},this.errorFn=function(a){throw"FORTH ERROR: "+a},this.setErrorFunction=function(a){this.errorFn=a},this.addToDictionary(".",function(){g.log(g.popFromDataStack())}),this.addToDictionary("true",function(){g.pushToDataStack(g.getValue("true"))}),this.addToDictionary("false",function(){g.pushToDataStack(g.getValue("false"))}),this.addToDictionary(".s",function(){g.dataStack.length<1?g.log("[stack empty]"):g.log(g.dataStack)}),this.addToDictionary(".l",function(){g.log(g.dataStack.length)}),this.addToDictionary(".cs",function(){g.dataStack.length=0}),this.addToDictionary("dup",function(){var a=g.popFromDataStack();a&&(g.pushToDataStack(a),g.pushToDataStack(a))}),this.addToDictionary("drop",function(){g.popFromDataStack()}),this.addToDictionary("swap",function(){var a=g.popFromDataStack(),b=g.popFromDataStack();g.pushToDataStack(a,b)}),this.addToDictionary("over",function(){g.dataStack.length<2&&g.error("Not enough items for OVER!");var a=g.dataStack[g.dataStack.length-2];g.pushToDataStack(a)}),this.addToDictionary("roll",function(){if(g.dataStack.length<2)g.error("ROLL needs something to work with, nothing on stack!");else{var a=g.popFromDataStack();if(g.dataStack.length<a+1)g.error("ROLL specifed a larger number then number of items on stack!");else{var b=g.dataStack.splice(g.dataStack.length-a-1,1);g.pushToDataStack(b[0])}}}),this.addToDictionary("js@",function(){g.executeString("word @")}),this.addToDictionary("js!",function(){g.executeString("word"),g.executeString("swap !")}),this.addToDictionary("+",function(){var a=g.popFromDataStack(),b=g.popFromDataStack();g.pushToDataStack(a+b)}),this.addToDictionary("-",function(){var a=g.popFromDataStack(),b=g.popFromDataStack();g.pushToDataStack(b-a)}),this.addToDictionary("*",function(){var a=g.popFromDataStack(),b=g.popFromDataStack();g.pushToDataStack(a*b)}),this.addToDictionary("/",function(){var a=g.popFromDataStack(),b=g.popFromDataStack();g.pushToDataStack(b/a)}),this.addToDictionary("%",function(){var a=g.popFromDataStack(),b=g.popFromDataStack();g.pushToDataStack(b%a)}),this.addToDictionary("=",function(){var a=g.popFromDataStack();if(g.dataStack.length<1)g.error("2 items needed for EQUAL!");else{var b=g.popFromDataStack();g.pushToDataStack(a===b)}}),this.addToDictionary("word",function(){var a=g.commands.shift();a?g.pushToDataStack(a):g.error("No more words for WORD")}),this.addToDictionary("lit",function(){var a=g.commands.shift();if(a){var b=parseFloat(a);isNaN(b)?g.pushToDataStack(a):g.pushToDataStack(b)}},!0),this.addToDictionary("find",function(){var a=g.popFromDataStack(),b=g.findDefinition(a);return b?(g.pushToDataStack(b),void 0):(g.error("Cannot find word '"+a+"'"),void 0)}),this.addToDictionary(">cfa",function(){var a=g.popFromDataStack();a.fn?g.pushToDataStack(a.fn):g.error(">CFA requires a found defn.")}),this.addToDictionary("!",function(){if(g.dataStack.length>1){var a=g.popFromDataStack(),b=g.popFromDataStack();g.setValue(b,a)}else g.error("! needs a name and value")}),this.addToDictionary("@",function(){if(g.dataStack.length>0){var a=g.popFromDataStack(),b=g.getValue(a);void 0!==b?g.pushToDataStack(b):g.error("value '"+a+"' is undefined!")}else g.error("@ needs a name input")}),this.addToDictionary("!)?",function(){var a=g.commands.shift();g.pushToDataStack(a.indexOf(")")<0)}),this.addToDictionary("not",function(){g.pushToDataStack(!g.popFromDataStack())}),this.addToDictionary("while",function(){for(;g.popFromDataStack();)g.executeWords("dup","exec");g.executeWords("drop")}),this.addToDictionary("(",function(){for(var a;(a=g.commands.shift())&&-1==a.indexOf(")"););},!0),this.addToDictionary("'",function(){g.executeWords("word","find",">cfa")}),this.addToDictionary("create",function(){if(g.newCommand&&g.error("Already compiling "+g.newCommand.name+"!"),g.dataStack.length>0){var a=new c(g.popFromDataStack(),g.dictionaryHead,g);return g.newCommand=a,void 0}g.error("CREATE needs a name.")}),this.addToDictionary("fn{",function(){g.compilationMode=!0,g.newCommand||(g.newCommand=new c("Anonymous",void 0,g))}),this.addToDictionary("}",function(){g.compilationMode=!1,g.newCommand&&(g.pushToDataStack(g.newCommand),g.newCommand.executeAfterCreation&&g.executeWords("exec"),g.newCommand=void 0)},!0),this.addToDictionary("exec",function(){if(g.dataStack.length>0){var a=g.popFromDataStack();"function"==typeof a?a.call(g):a.fn?a.fn.call(g):g.error(""+a+" is not executable!")}else g.error("exec needs a function or command ref on the stack!")}),this.addToDictionary(";",function(){g.executeWords("}");var a=g.popFromDataStack();if(a){if(a&&a.name){var b=g.findDefinition(a.name);b&&g.log(a.name+" is not unique.")}g.dictionaryHead=a}},!0),this.addToDictionary(":",function(){g.executeWords("word","create","fn{")}),this.addToDictionary("[",function(){g.compilationMode=!0,g.newCommand=new d(g)}),this.addToDictionary("]",function(){g.compilationMode=!1,g.newCommand&&(g.newCommand.fn(),g.newCommand=void 0)},!0),this.addToDictionary("array?",function(){g.pushToDataStack(Array.isArray(g.popFromDataStack()))}),this.addToDictionary("{",function(){g.compilationMode=!0,g.newCommand=new e(g)}),this.addToDictionary("object?",function(){var a=g.popFromDataStack();g.pushToDataStack(a===Object(a))}),this.addToDictionary("concat",function(){var a=g.popFromDataStack();Array.isArray(a)?g.pushToDataStack(a.concat(g.popFromDataStack())):g.error("first item on the stack needs to be an array for concat")}),this.interpret(": rot ( a b c -- b c a ) 2 roll ;"),this.interpret(": inc 1 + ;"),this.interpret(": dec 1 - ;"),this.addToDictionary(".list",function(){var a=g.dictionaryHead;if(a)do g.log(a.name);while(a=a.prev)},!0),this.addToDictionary(".values",function(){var a=Object.getOwnPropertyNames(g.valueStore),b=a.map(function(a){return g.valueStore[a]});g.log(b)}),this.addToDictionary(".keys",function(){var a=Object.getOwnPropertyNames(g.valueStore);g.log(a)}),this.addToDictionary(".vs",function(){g.log(g.valueStore)})}}("undefined"==typeof exports?this.salliedforth={}:exports);