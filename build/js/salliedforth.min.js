/*! salliedforth 2014-Dec-31 */
!function(a){"use strict";function b(a,b){var c;for(c in b)b.hasOwnProperty(c)&&(a.hasOwnProperty(c)||void 0!==a[c]||(a[c]=b[c]));return a}function c(a,b){if(a.length>0){var d=a.shift(),e=b[d];return void 0!==e?c(a,e):void 0}return b}function d(a){return a===Object(a)}var e=function(a,b,c,d){var e=this;this.name=a,this.fn=function(){e.functions.forEach(function(a){a.call(c)})},this.errorFn=d||function(a){console.error("FORTH ERROR::CustomCommand: "+a)},this.prev=b,this.functions=[],this.add=function(a){"function"==typeof a?e.functions.push(a):e.functions.push(function(){c.pushToDataStack(function(a){return a}(a))})},this.executeAfterCreation=!1};e.prototype.getMetaData=function(){return{type:"CustomCommand"}},e.prototype.apply=function(a,b){return this.fn.apply(a,b)};var f=function(a){var b=this;this._data=[],this.fn=function(){a.pushToDataStack(b._data)},this.add=function(a){b._data.push(a)},this.executeAfterCreation=!0},g=function(a){var b=this;this._data={},this.fn=function(){void 0===b.key?a.pushToDataStack(b._data):a.error("Unmatched key value pairs when defining Object. Key '"+b.key+"' does not have a value!")},this.key=void 0,this.add=function(a){void 0===b.key?b.key=a:(b._data[b.key]=a,b.key=void 0)},this.executeAfterCreation=!0},h=function(a){var b=this;this.name=a,this._stack=[],this.push=function(a){return b._stack.push(a),b},this.pop=function(){return b._stack.pop()},this.current=function(){return b._stack[b._stack.length-1]},this.clear=function(){return b._stack.length=0,b},this.isEmpty=function(){return b._stack.length<1}},i=function(){h.call(this,"Command Stack");var a=this;this.addToCurrent=function(b){a.current().add(b)}},j=function(a){this.data=[],this.status=a,this.stackSize=0,this.returnStackSize=0};j.prototype.push=function(a){this.data.push(a)},j.prototype.pop=function(){return this.data.pop()},a.Interpreter=function(a){function k(a,b){function c(){return a.apply(this,b)}return c.prototype=a.prototype,c.prototype.toString=b.length<1?function(){return"["+a.cname+"()]"}:function(){return"["+a.cname+"("+b+")]"},new c}function l(a,b){return a.getMetaData=function(){return b},a}var m=this;this.dataStack=[],this.returnStack=[],this.dictionaryHead=void 0,this.newCommands=new i,this._compilationModeStack=new h,this.compilationMode=function(){return!!this._compilationModeStack.current()},this.enterCompilationMode=function(){this._compilationModeStack.push(!0)},this.leaveCompilationMode=function(){this._compilationModeStack.pop()},this.valueStore=b(a||{},{"false":!1,"true":!0}),this.version={major:0,minor:0,build:2,revision:void 0},this.versionString=""+this.version.major+"."+this.version.minor+"."+this.version.build,this.version.revision&&(this.versionString=this.versionString+"."+this.version.revision),this.log=function(a){return m.logFn&&m.logFn(a),void 0},this.error=function(a){return m.errorFn&&m.errorFn(a),void 0},this.pushToDataStack=function(){var a=Array.prototype.slice.call(arguments);a.forEach(function(a){m.dataStack.push(a)})},this.popFromDataStack=function(){return m.dataStack.length<1&&m.error("DataStackUnderFlow!"),m.dataStack.pop()},this.pushToReturnStack=function(){var a=Array.prototype.slice.call(arguments);a.forEach(function(a){m.returnStack.push(a)})},this.popFromReturnStack=function(){return m.returnStack.length<1&&m.error("ReturnStackUnderFlow!"),m.returnStack.pop()},this.addToDictionary=function(a,b,c){if(m.dictionaryHead){var d={name:a,fn:b,prev:m.dictionaryHead,immediate:!!c};m.dictionaryHead=d}else m.dictionaryHead={name:a,fn:b,immediate:!!c}},this.setValue=function(a,b){this.valueStore[a]=b},this.getValue=function(a){var b=m.valueStore[a];if(!b){var d=a.split(".");d.length>1&&(b=c(d,m.valueStore))}return b},this.findDefn=function(a,b){return b===a.name?a:a.prev?m.findDefn(a.prev,b):void 0},this.findJSDefinition=function(a){var b;if(b=m.getValue(a)){var c=new e(a,void 0,m.valueStore);return c.add(function(){var a=b();return void 0!==a?a:void 0}),c}},this.findWordDefinition=function(a){if(m.dictionaryHead){var b=m.findDefn(m.dictionaryHead,a);if(b)return b}return void 0},this.executeFunctions=function(){var a=Array.prototype.slice.call(arguments);a.forEach(function(a){a.call(m)})},this.executeWords=function(){var a=Array.prototype.slice.call(arguments);try{var b=a.map(function(a){var b=m.findWordDefinition(a);if(b)return b.fn;if(b=m.findJSDefinition(a))return b.fn;throw"Function "+a+" not found!"});m.executeFunctions.apply(m,b)}catch(c){m.error(c)}},this.executeString=function(a){m.executeWords.apply(m,a.split(" "))},this.processCommands=function(){for(var a;a=m.commands.shift();)if(a){var b=parseFloat(a);if(isNaN(b))if(m.compilationMode()){var c=m.findWordDefinition(a);c?c.immediate?c.fn():m.newCommands.addToCurrent(c.fn):m.newCommands.addToCurrent(a)}else m.executeWords(a);else m.compilationMode()?m.newCommands.addToCurrent(b):m.pushToDataStack(b)}},this.interpret=function(a){return m.response=new j("OK."),m.commands=a.split(/\s+/).filter(function(a){return""!==a.trim()}),m.processCommands(),m.response.stackSize=m.dataStack.length,m.response.returnStackSize=m.returnStack.length,m.response},this.logFn=function(a){m.response.push(a)},this.setLogFunction=function(a){this.logFn=a},this.errorFn=function(a){throw"FORTH ERROR: "+a},this.setErrorFunction=function(a){this.errorFn=a},this.addToDictionary("log",function(){console.log(m.popFromDataStack())}),this.addToDictionary(".",function(){m.log(m.popFromDataStack())}),this.addToDictionary("true",function(){m.pushToDataStack(m.getValue("true"))}),this.addToDictionary("false",function(){m.pushToDataStack(m.getValue("false"))}),this.addToDictionary(".s",function(){m.dataStack.length<1?m.log("[data stack empty]"):m.log(m.dataStack)}),this.addToDictionary(".rs",function(){m.returnStack.length<1?m.log("[return stack empty]"):m.log(m.returnStack)}),this.addToDictionary(".l",function(){m.log(m.dataStack.length)}),this.addToDictionary(".cs",function(){m.dataStack.length=0}),this.addToDictionary(".log",function(){console.log.apply(console,["STACK >>"].concat(m.dataStack.map(function(a){return a.toString()})))}),this.addToDictionary(">R",function(){var a=m.popFromDataStack();m.pushToReturnStack(a)}),this.addToDictionary("R>",function(){var a=m.popFromReturnStack();m.pushToDataStack(a)}),this.addToDictionary("R@",function(){var a=m.popFromReturnStack();a&&(m.pushToReturnStack(a),m.pushToDataStack(a))}),this.addToDictionary("I",function(){var a=m.popFromReturnStack();a&&(m.pushToReturnStack(a),m.pushToDataStack(a))}),this.addToDictionary("J",function(){var a=m.returnStack.length;3>a&&m.error("J needs 3 items on the return stack. There were only "+a);var b=m.returnStack[a-3];m.pushToDataStack(b)}),this.addToDictionary("dup",function(){var a=m.popFromDataStack();a&&(m.pushToDataStack(a),m.pushToDataStack(a))}),this.addToDictionary("drop",function(){m.popFromDataStack()}),this.addToDictionary("swap",function(){var a=m.popFromDataStack(),b=m.popFromDataStack();m.pushToDataStack(a,b)}),this.addToDictionary("over",function(){m.dataStack.length<2&&m.error("Not enough items for OVER!");var a=m.dataStack[m.dataStack.length-2];m.pushToDataStack(a)}),this.addToDictionary("roll",function(){if(m.dataStack.length<2)m.error("ROLL needs something to work with, nothing on stack!");else{var a=m.popFromDataStack();if(m.dataStack.length<a+1)m.error("ROLL specifed a larger number then number of items on stack!");else{var b=m.dataStack.splice(m.dataStack.length-a-1,1);m.pushToDataStack(b[0])}}}),this.getJSContextFor=function(a){var b=m.valueStore;return"console."===a.substr(0,8)?b=window.console:"document."==a.substr(0,9)&&(b=document),b},this.addToDictionary("get",function(){var a=m.popFromDataStack();if(d(a)){m.executeWords("word");var b=m.popFromDataStack();m.pushToDataStack(a);var e=c(b.split("."),a);"function"==typeof e&&(e=l(e,{context:a})),m.pushToDataStack(e)}}),this.addToDictionary("set",function(){var a=m.popFromDataStack(),b=m.popFromDataStack();if(d(b)){m.executeWords("word");var e=m.popFromDataStack(),f=e.split(".");e=f.pop();var g=c(f,b);g[e]=a,m.pushToDataStack(b)}}),this.addToDictionary("pop",function(){var a=m.popFromDataStack();Array.isArray(a)?(m.pushToDataStack(a),m.pushToDataStack(a.pop())):m.error("Not an array for pop! "+a)}),this.addToDictionary("push",function(){var a=m.popFromDataStack(),b=m.popFromDataStack();Array.isArray(b)?(b.push(a),m.pushToDataStack(b)):m.error("Not an array for pop! "+b)}),this.addToDictionary("js",function(){var a,b,c;if(m.compilationMode())m.executeString("word dup @"),a=m.popFromDataStack(),b=m.popFromDataStack(),c=m.getJSContextFor(b),m.newCommands.addToCurrent(function(a,b,c){return function(){var b=m.popFromDataStack();a.apply(c,b)}}(a,b,c));else{var d=m.popFromDataStack();m.executeString("word dup @"),a=m.popFromDataStack(),b=m.popFromDataStack(),c=m.getJSContextFor(b),a.apply(c,d)}},!0),this.addToDictionary("js-",function(){var a,b,c,d;if(m.compilationMode())m.executeString("word dup @"),a=m.popFromDataStack(),b=m.popFromDataStack(),c=m.getJSContextFor(b),m.newCommands.addToCurrent(function(b,c,d){return function(){var b=m.popFromDataStack(),c=a.apply(d,b);m.pushToDataStack(c)}}(a,b,c));else{var e=m.popFromDataStack();m.executeString("word dup @"),a=m.popFromDataStack(),b=m.popFromDataStack(),c=m.getJSContextFor(b),d=a.apply(c,e),m.pushToDataStack(d)}},!0),this.addToDictionary("jsnew",function(){var a;m.executeString("word dup @"),a=m.popFromDataStack(),a.cname=m.popFromDataStack();var b=m.popFromDataStack(),c=k(a,b);m.pushToDataStack(c)}),this.addToDictionary("jsexec",function(){var a=m.popFromDataStack(),b=m.popFromDataStack(),c=b.getMetaData&&b.getMetaData();c&&c.context?b.apply(c.context,a):b.apply(null,a)}),this.addToDictionary("jsexec-",function(){var a=m.popFromDataStack(),b=m.popFromDataStack(),c=b.apply(null,a);m.pushToDataStack(c)}),this.addToDictionary("arity",function(){for(var a=m.popFromDataStack(),b=l([],{arity:a});a--;)b.unshift(m.popFromDataStack());m.pushToDataStack(b)}),this.addToDictionary("+",function(){var a=m.popFromDataStack(),b=m.popFromDataStack();m.pushToDataStack(a+b)}),this.addToDictionary("-",function(){var a=m.popFromDataStack(),b=m.popFromDataStack();m.pushToDataStack(b-a)}),this.addToDictionary("*",function(){var a=m.popFromDataStack(),b=m.popFromDataStack();m.pushToDataStack(a*b)}),this.addToDictionary("/",function(){var a=m.popFromDataStack(),b=m.popFromDataStack();m.pushToDataStack(b/a)}),this.addToDictionary("%",function(){var a=m.popFromDataStack(),b=m.popFromDataStack();m.pushToDataStack(b%a)}),this.addToDictionary("=",function(){var a=m.popFromDataStack();if(m.dataStack.length<1)m.error("2 items needed for EQUAL!");else{var b=m.popFromDataStack();m.pushToDataStack(a===b)}}),this.addToDictionary(">",function(){var a=m.popFromDataStack();if(m.dataStack.length<1)m.error("2 items needed for > !");else{var b=m.popFromDataStack();m.pushToDataStack(b>a)}}),this.addToDictionary("word",function(){var a=m.commands.shift();a?m.pushToDataStack(a):m.error("No more words for WORD")}),this.addToDictionary("lit",function(){var a=m.commands.shift();if(a){var b=parseFloat(a);isNaN(b)?m.pushToDataStack(a):m.pushToDataStack(b)}},!0),this.addToDictionary("find",function(){var a=m.popFromDataStack(),b=m.findWordDefinition(a);return b?(m.pushToDataStack(b),void 0):(b=m.findJSDefinition(a))?(m.pushToDataStack(b),void 0):(m.error("Cannot find word '"+a+"'"),void 0)}),this.addToDictionary(">cfa",function(){var a=m.popFromDataStack();a.fn?m.pushToDataStack(a.fn):m.error(">CFA requires a found defn.")}),this.addToDictionary("!",function(){if(m.dataStack.length>1){var a=m.popFromDataStack(),b=m.popFromDataStack();m.setValue(a,b)}else m.error("! needs a name and value")}),this.addToDictionary("@",function(){if(m.dataStack.length>0){var a=m.popFromDataStack(),b=m.getValue(a);void 0!==b?m.pushToDataStack(b):m.error("value '"+a+"' is undefined!")}else m.error("@ needs a name input")}),this.addToDictionary("!)?",function(){var a=m.commands.shift();m.pushToDataStack(a.indexOf(")")<0)}),this.addToDictionary("not",function(){m.pushToDataStack(!m.popFromDataStack())}),this.addToDictionary("while",function(){for(;m.popFromDataStack();)m.executeWords("dup","exec");m.executeWords("drop")}),this.addToDictionary("(",function(){for(var a;(a=m.commands.shift())&&-1==a.indexOf(")"););},!0),this.addToDictionary('"',function(){for(var a,b="";(a=m.commands.shift())&&-1==a.indexOf('"');)b+=a+" ";b+=a.split('"')[0],m.pushToDataStack(b.trim()),m.compilationMode()&&m.newCommands.addToCurrent(function(a){return function(){m.pushToDataStack(a)}}(m.popFromDataStack()))},!0),this.addToDictionary("'",function(){m.executeWords("word","find",">cfa")}),this.addToDictionary("create",function(){var a=m.commands.shift();if(a&&(m.pushToDataStack(a),m.dataStack.length>0)){var b=new e(m.popFromDataStack(),m.dictionaryHead,m);return m.newCommands.push(b),void 0}m.error("CREATE needs a name.")}),this.addToDictionary("fn{",function(){m.newCommands.push(new e("Anonymous",void 0,m)),m.enterCompilationMode()}),this.addToDictionary("}",function(){if(m.leaveCompilationMode(),m.newCommands.current()){var a=m.newCommands.pop();m.pushToDataStack(a),a.executeAfterCreation&&m.executeWords("exec"),m.newCommands.current()&&m.compilationMode()&&m.newCommands.addToCurrent(m.popFromDataStack())}},!0),this.addToDictionary("exec",function(){if(m.dataStack.length>0){var a=m.popFromDataStack();"function"==typeof a?a.call(m):a.fn?a.fn.call(m):m.error(""+a+" is not executable!")}else m.error("exec needs a function or command ref on the stack!")}),this.addToDictionary(";",function(){m.executeWords("}");var a=m.popFromDataStack();if(a){if(a&&a.name){var b=m.findWordDefinition(a.name);b&&m.log(a.name+" is not unique.")}m.dictionaryHead=a}},!0),this.addToDictionary(":",function(){m.executeWords("create"),m.enterCompilationMode()}),this.addToDictionary("do",function(){m.interpret("swap >R >R"),m.newCommands.push(new e("Anonymous",void 0,m)),m.enterCompilationMode()}),this.addToDictionary("loop",function(){m.interpret("} R> inc >R")},!0),this.addToDictionary("[",function(){m.newCommands.push(new f(m)),m.enterCompilationMode()},!0),this.addToDictionary("]",function(){m.executeString("}")},!0),this.addToDictionary("array?",function(){m.pushToDataStack(Array.isArray(m.popFromDataStack()))}),this.addToDictionary("[]",function(){m.pushToDataStack([])}),this.addToDictionary("{}",function(){m.pushToDataStack({})}),this.addToDictionary("undefined",function(){m.pushToDataStack(void 0)}),this.addToDictionary("null",function(){m.pushToDataStack(null)}),this.interpret(": call word @ exec ;"),this.interpret(": arity1 1 arity ;"),this.interpret(": arity2 2 arity ;"),this.interpret(": arity3 3 arity ;"),this.interpret(": arity4 4 arity ;"),this.addToDictionary("{",function(){m.newCommands.push(new g(m)),m.enterCompilationMode()},!0),this.addToDictionary("object?",function(){var a=m.popFromDataStack();m.pushToDataStack(d(a))}),this.addToDictionary("concat",function(){var a=m.popFromDataStack();Array.isArray(a)?m.pushToDataStack(a.concat(m.popFromDataStack())):m.error("first item on the stack needs to be an array for concat")}),this.interpret(": rot 2 roll ;"),this.interpret(": inc 1 + ;"),this.interpret(": dec 1 - ;"),this.addToDictionary(".list",function(){var a=m.dictionaryHead;if(a)do m.log(a.name);while(a=a.prev)},!0),this.addToDictionary(".values",function(){var a=Object.getOwnPropertyNames(m.valueStore),b=a.map(function(a){return m.valueStore[a]});m.log(b)}),this.addToDictionary(".keys",function(){var a=Object.getOwnPropertyNames(m.valueStore);m.log(a)}),this.addToDictionary(".vs",function(){m.log(m.valueStore)})}}("undefined"==typeof exports?this.salliedforth={}:exports);